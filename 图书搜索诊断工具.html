<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦æœç´¢åŠŸèƒ½è¯Šæ–­</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #ddd; 
            border-radius: 8px;
            background: #f8f9fa;
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            background: #74b9ff;
            color: white;
        }
        button:hover { 
            background: #0984e3; 
            transform: translateY(-2px); 
        }
        .success { color: #00b894; font-weight: bold; }
        .error { color: #e17055; font-weight: bold; }
        .info { color: #0984e3; font-weight: bold; }
        textarea { 
            width: 100%; 
            height: 300px; 
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .book-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š å›¾ä¹¦æœç´¢åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
        
        <!-- æ•°æ®åº“è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ”— æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>
            <button onclick="testDatabaseConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
            <button onclick="checkBookData()">æ£€æŸ¥å›¾ä¹¦æ•°æ®</button>
            <div id="dbResult"></div>
        </div>

        <!-- å›¾ä¹¦æœç´¢æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ” å›¾ä¹¦æœç´¢åŠŸèƒ½æµ‹è¯•</h3>
            <div>
                <input type="text" id="searchKeyword" placeholder="è¾“å…¥å›¾ä¹¦åç§°æˆ–å…³é”®å­—" value="å¤§é›ª">
                <button onclick="testBookSearch()">ç®¡ç†å‘˜æœç´¢æµ‹è¯•</button>
                <button onclick="testReaderSearch()">è¯»è€…æœç´¢æµ‹è¯•</button>
            </div>
            <div>
                <h4>å¸¸ç”¨æµ‹è¯•å…³é”®å­—ï¼š</h4>
                <button onclick="testSpecificBook('å¤§é›ª')">å¤§é›ª</button>
                <button onclick="testSpecificBook('ä¸‰ç”Ÿ')">ä¸‰ç”Ÿ</button>
                <button onclick="testSpecificBook('ä½•ä»¥')">ä½•ä»¥</button>
                <button onclick="testSpecificBook('äººç±»')">äººç±»</button>
                <button onclick="testSpecificBook('ä¸œé‡')">ä¸œé‡</button>
                <button onclick="testSpecificBook('10000001')">å›¾ä¹¦ID:10000001</button>
            </div>
            <div id="searchResult"></div>
        </div>

        <!-- APIç«¯ç‚¹æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ› ï¸ APIç«¯ç‚¹ç›´æ¥æµ‹è¯•</h3>
            <button onclick="testAllBooksAPI()">è·å–æ‰€æœ‰å›¾ä¹¦</button>
            <button onclick="testMatchBookAPI()">æµ‹è¯•å›¾ä¹¦åŒ¹é…</button>
            <button onclick="testQueryBookAPI()">æµ‹è¯•å›¾ä¹¦æŸ¥è¯¢</button>
            <div id="apiResult"></div>
        </div>

        <!-- æ•°æ®åº“æ•°æ®å±•ç¤º -->
        <div class="test-section">
            <h3>ğŸ“– æ•°æ®åº“å›¾ä¹¦æ•°æ®</h3>
            <button onclick="showBookList()">æ˜¾ç¤ºæ‰€æœ‰å›¾ä¹¦</button>
            <div id="bookList" class="book-list"></div>
        </div>

        <!-- è°ƒè¯•æ—¥å¿— -->
        <div class="test-section">
            <h3>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h3>
            <textarea id="debugLog" readonly placeholder="è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            <br>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const debugLog = document.getElementById('debugLog');
            const typeEmoji = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸'
            };
            debugLog.value += `[${timestamp}] ${typeEmoji[type] || 'â„¹ï¸'} ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').value = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        function exportLog() {
            const logContent = document.getElementById('debugLog').value;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å›¾ä¹¦æœç´¢è¯Šæ–­æ—¥å¿—_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        function updateResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = 'test-result ' + (isSuccess ? 'success' : 'error');
        }

        function testDatabaseConnection() {
            log('æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
            fetch('http://localhost:9000/allbooks.html')
                .then(response => {
                    log(`æ•°æ®åº“è¿æ¥æµ‹è¯•å“åº”çŠ¶æ€: ${response.status}`, 'info');
                    return response.text();
                })
                .then(html => {
                    if (html.includes('error') || html.includes('æ•°æ®åº“')) {
                        updateResult('dbResult', 'âŒ æ•°æ®åº“è¿æ¥å¯èƒ½æœ‰é—®é¢˜', false);
                        log('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                    } else {
                        updateResult('dbResult', 'âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸', true);
                        log('æ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
                    }
                })
                .catch(error => {
                    log(`æ•°æ®åº“è¿æ¥æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
                    updateResult('dbResult', `âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, false);
                });
        }

        function checkBookData() {
            log('æ£€æŸ¥å›¾ä¹¦æ•°æ®...', 'info');
            fetch('http://localhost:9000/allbooks.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const bookRows = doc.querySelectorAll('tbody tr');
                    
                    if (bookRows.length > 0) {
                        updateResult('dbResult', `âœ… æ•°æ®åº“ä¸­æœ‰ ${bookRows.length} æœ¬å›¾ä¹¦`, true);
                        log(`å‘ç° ${bookRows.length} æœ¬å›¾ä¹¦`, 'success');
                        
                        // æ˜¾ç¤ºå‰å‡ æœ¬ä¹¦çš„ä¿¡æ¯
                        let bookInfo = 'å‰5æœ¬å›¾ä¹¦ï¼š\n';
                        for (let i = 0; i < Math.min(5, bookRows.length); i++) {
                            const cells = bookRows[i].querySelectorAll('td');
                            if (cells.length > 0) {
                                bookInfo += `${i+1}. ${cells[0].textContent.trim()}\n`;
                            }
                        }
                        log(bookInfo, 'info');
                    } else {
                        updateResult('dbResult', 'âŒ æ•°æ®åº“ä¸­æ²¡æœ‰å›¾ä¹¦æ•°æ®', false);
                        log('æ•°æ®åº“ä¸­æ²¡æœ‰å›¾ä¹¦æ•°æ®', 'error');
                    }
                })
                .catch(error => {
                    log(`æ£€æŸ¥å›¾ä¹¦æ•°æ®é”™è¯¯: ${error.message}`, 'error');
                    updateResult('dbResult', `âŒ æ£€æŸ¥å›¾ä¹¦æ•°æ®å¤±è´¥: ${error.message}`, false);
                });
        }

        function testBookSearch() {
            const keyword = document.getElementById('searchKeyword').value;
            if (!keyword) {
                updateResult('searchResult', 'âŒ è¯·è¾“å…¥æœç´¢å…³é”®å­—', false);
                return;
            }
            
            log(`æµ‹è¯•ç®¡ç†å‘˜å›¾ä¹¦æœç´¢: ${keyword}`, 'info');
            
            const formData = new FormData();
            formData.append('searchWord', keyword);
            
            fetch('http://localhost:9000/querybook.html', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                log(`ç®¡ç†å‘˜æœç´¢å“åº”çŠ¶æ€: ${response.status}`, 'info');
                return response.text();
            })
            .then(html => {
                log('ç®¡ç†å‘˜æœç´¢å“åº”å·²æ”¶åˆ°', 'info');
                
                if (html.includes('æ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦')) {
                    updateResult('searchResult', `âŒ æœç´¢"${keyword}"ï¼šæ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦`, false);
                    log(`æœç´¢"${keyword}"ï¼šæ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦`, 'warning');
                } else {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const bookRows = doc.querySelectorAll('tbody tr');
                    
                    if (bookRows.length > 0) {
                        updateResult('searchResult', `âœ… æœç´¢"${keyword}"ï¼šæ‰¾åˆ° ${bookRows.length} æœ¬å›¾ä¹¦`, true);
                        log(`æœç´¢"${keyword}"ï¼šæ‰¾åˆ° ${bookRows.length} æœ¬å›¾ä¹¦`, 'success');
                        
                        // æ˜¾ç¤ºæœç´¢ç»“æœ
                        let results = 'æœç´¢ç»“æœï¼š\n';
                        for (let i = 0; i < Math.min(3, bookRows.length); i++) {
                            const cells = bookRows[i].querySelectorAll('td');
                            if (cells.length > 0) {
                                results += `${i+1}. ${cells[0].textContent.trim()}\n`;
                            }
                        }
                        log(results, 'info');
                    } else {
                        updateResult('searchResult', `âš ï¸ æœç´¢"${keyword}"ï¼šå“åº”æ ¼å¼å¼‚å¸¸`, false);
                        log(`æœç´¢"${keyword}"ï¼šå“åº”æ ¼å¼å¼‚å¸¸`, 'warning');
                    }
                }
            })
            .catch(error => {
                log(`ç®¡ç†å‘˜æœç´¢é”™è¯¯: ${error.message}`, 'error');
                updateResult('searchResult', `âŒ æœç´¢å¤±è´¥: ${error.message}`, false);
            });
        }

        function testReaderSearch() {
            const keyword = document.getElementById('searchKeyword').value;
            if (!keyword) {
                updateResult('searchResult', 'âŒ è¯·è¾“å…¥æœç´¢å…³é”®å­—', false);
                return;
            }
            
            log(`æµ‹è¯•è¯»è€…å›¾ä¹¦æœç´¢: ${keyword}`, 'info');
            
            const formData = new FormData();
            formData.append('searchWord', keyword);
            
            fetch('http://localhost:9000/reader_querybook_do.html', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                log(`è¯»è€…æœç´¢å“åº”çŠ¶æ€: ${response.status}`, 'info');
                return response.text();
            })
            .then(html => {
                log('è¯»è€…æœç´¢å“åº”å·²æ”¶åˆ°', 'info');
                
                if (html.includes('æ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦')) {
                    updateResult('searchResult', `âŒ è¯»è€…æœç´¢"${keyword}"ï¼šæ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦`, false);
                    log(`è¯»è€…æœç´¢"${keyword}"ï¼šæ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦`, 'warning');
                } else {
                    updateResult('searchResult', `âœ… è¯»è€…æœç´¢"${keyword}"ï¼šæœç´¢æˆåŠŸ`, true);
                    log(`è¯»è€…æœç´¢"${keyword}"ï¼šæœç´¢æˆåŠŸ`, 'success');
                }
            })
            .catch(error => {
                log(`è¯»è€…æœç´¢é”™è¯¯: ${error.message}`, 'error');
                updateResult('searchResult', `âŒ è¯»è€…æœç´¢å¤±è´¥: ${error.message}`, false);
            });
        }

        function testSpecificBook(keyword) {
            document.getElementById('searchKeyword').value = keyword;
            testBookSearch();
        }

        function testAllBooksAPI() {
            log('æµ‹è¯•è·å–æ‰€æœ‰å›¾ä¹¦API...', 'info');
            fetch('http://localhost:9000/allbooks.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const bookRows = doc.querySelectorAll('tbody tr');
                    
                    updateResult('apiResult', `âœ… APIæµ‹è¯•æˆåŠŸï¼Œè¿”å› ${bookRows.length} æœ¬å›¾ä¹¦`, true);
                    log(`APIæµ‹è¯•æˆåŠŸï¼Œè¿”å› ${bookRows.length} æœ¬å›¾ä¹¦`, 'success');
                })
                .catch(error => {
                    log(`APIæµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
                    updateResult('apiResult', `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`, false);
                });
        }

        function testMatchBookAPI() {
            log('æµ‹è¯•å›¾ä¹¦åŒ¹é…API...', 'info');
            updateResult('apiResult', 'â„¹ï¸ å›¾ä¹¦åŒ¹é…APIéœ€è¦é€šè¿‡æœç´¢æµ‹è¯•æ¥éªŒè¯', false);
        }

        function testQueryBookAPI() {
            log('æµ‹è¯•å›¾ä¹¦æŸ¥è¯¢API...', 'info');
            updateResult('apiResult', 'â„¹ï¸ å›¾ä¹¦æŸ¥è¯¢APIéœ€è¦é€šè¿‡æœç´¢æµ‹è¯•æ¥éªŒè¯', false);
        }

        function showBookList() {
            log('è·å–å›¾ä¹¦åˆ—è¡¨...', 'info');
            fetch('http://localhost:9000/allbooks.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const bookRows = doc.querySelectorAll('tbody tr');
                    
                    let bookListHtml = '<h4>å›¾ä¹¦åˆ—è¡¨ï¼š</h4>';
                    for (let i = 0; i < bookRows.length; i++) {
                        const cells = bookRows[i].querySelectorAll('td');
                        if (cells.length >= 4) {
                            bookListHtml += `<div style="padding: 5px; border-bottom: 1px solid #eee;">
                                <strong>${cells[0].textContent.trim()}</strong> - 
                                ${cells[1].textContent.trim()} - 
                                ${cells[2].textContent.trim()}
                            </div>`;
                        }
                    }
                    
                    document.getElementById('bookList').innerHTML = bookListHtml;
                    log(`æ˜¾ç¤ºäº† ${bookRows.length} æœ¬å›¾ä¹¦`, 'success');
                })
                .catch(error => {
                    log(`è·å–å›¾ä¹¦åˆ—è¡¨é”™è¯¯: ${error.message}`, 'error');
                    document.getElementById('bookList').innerHTML = `âŒ è·å–å›¾ä¹¦åˆ—è¡¨å¤±è´¥: ${error.message}`;
                });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡ŒåŸºç¡€æ£€æŸ¥
        window.onload = function() {
            log('å›¾ä¹¦æœç´¢è¯Šæ–­å·¥å…·åŠ è½½å®Œæˆ', 'info');
            setTimeout(() => {
                testDatabaseConnection();
                setTimeout(checkBookData, 1000);
            }, 500);
        };
    </script>
</body>
</html>
