<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ä¹¦æ·»åŠ åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #333; 
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .success {
            background-color: #27ae60;
        }
        .danger {
            background-color: #e74c3c;
        }
        .warning {
            background-color: #f39c12;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: none;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .quick-links {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š å›¾ä¹¦æ·»åŠ åŠŸèƒ½æµ‹è¯•ä¸è¯Šæ–­å·¥å…·</h1>
        
        <div class="quick-links">
            <button onclick="openLogin()">ğŸ”‘ ç™»å½•é¡µé¢</button>
            <button onclick="openAdminMain()">ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜ä¸»é¡µ</button>
            <button onclick="openBookAdd()">â• å›¾ä¹¦æ·»åŠ é¡µé¢</button>
            <button onclick="openAllBooks()">ğŸ“– æ‰€æœ‰å›¾ä¹¦</button>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€æµ‹è¯•</h3>
            <button onclick="testSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <button onclick="testDatabase()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
            <button onclick="checkLogs()">æŸ¥çœ‹æ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ å›¾ä¹¦æ·»åŠ æµ‹è¯•</h3>
            <button onclick="testSimpleAdd()">ç®€å•å›¾ä¹¦æ·»åŠ æµ‹è¯•</button>
            <button onclick="testComplexAdd()" class="warning">å¤æ‚æ•°æ®æµ‹è¯•</button>
            <button onclick="testInvalidData()" class="danger">æ— æ•ˆæ•°æ®æµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h3>ğŸ› HTTP 400 é”™è¯¯è¯Šæ–­</h3>
            <button onclick="diagnose400Error()">è¯Šæ–­400é”™è¯¯</button>
            <button onclick="testFormSubmission()">æµ‹è¯•è¡¨å•æäº¤</button>
            <button onclick="validateInputs()">éªŒè¯è¾“å…¥æ ¼å¼</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ‰‹åŠ¨æµ‹è¯•è¡¨å•</h3>
            <form id="testForm">
                <div class="form-group">
                    <label for="name">å›¾ä¹¦åç§°ï¼š</label>
                    <input type="text" id="name" name="name" value="æµ‹è¯•å›¾ä¹¦">
                </div>
                <div class="form-group">
                    <label for="author">ä½œè€…ï¼š</label>
                    <input type="text" id="author" name="author" value="æµ‹è¯•ä½œè€…">
                </div>
                <div class="form-group">
                    <label for="publish">å‡ºç‰ˆç¤¾ï¼š</label>
                    <input type="text" id="publish" name="publish" value="æµ‹è¯•å‡ºç‰ˆç¤¾">
                </div>
                <div class="form-group">
                    <label for="isbn">ISBNï¼š</label>
                    <input type="text" id="isbn" name="isbn" value="978-7-111-12345-6">
                </div>
                <div class="form-group">
                    <label for="introduction">ç®€ä»‹ï¼š</label>
                    <textarea id="introduction" name="introduction">è¿™æ˜¯ä¸€æœ¬æµ‹è¯•å›¾ä¹¦çš„ç®€ä»‹</textarea>
                </div>
                <div class="form-group">
                    <label for="language">è¯­è¨€ï¼š</label>
                    <input type="text" id="language" name="language" value="ä¸­æ–‡">
                </div>
                <div class="form-group">
                    <label for="price">ä»·æ ¼ï¼š</label>
                    <input type="number" id="price" name="price" value="29.99" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="pubdate">å‡ºç‰ˆæ—¥æœŸï¼š</label>
                    <input type="date" id="pubdate" name="pubdate" value="2024-01-01">
                </div>
                <div class="form-group">
                    <label for="classId">åˆ†ç±»å·ï¼š</label>
                    <input type="number" id="classId" name="classId" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="pressmark">ä¹¦æ¶å·ï¼š</label>
                    <input type="number" id="pressmark" name="pressmark" value="1001" min="1">
                </div>
                <div class="form-group">
                    <label for="state">çŠ¶æ€ï¼š</label>
                    <select id="state" name="state">
                        <option value="1">åœ¨é¦†</option>
                        <option value="0">å€Ÿå‡º</option>
                    </select>
                </div>
                <button type="button" onclick="submitTestForm()">æäº¤æµ‹è¯•è¡¨å•</button>
                <button type="button" onclick="fillRandomData()" class="warning">å¡«å……éšæœºæ•°æ®</button>
            </form>
        </div>

        <div id="results"></div>
    </div>

    <script>
        function showResults(message) {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.textContent = new Date().toLocaleTimeString() + ' - ' + message + '\n' + results.textContent;
        }

        function openLogin() {
            window.open('http://localhost:9000/login.html', '_blank');
        }

        function openAdminMain() {
            window.open('http://localhost:9000/admin_main.html', '_blank');
        }

        function openBookAdd() {
            window.open('http://localhost:9000/book_add.html', '_blank');
        }

        function openAllBooks() {
            window.open('http://localhost:9000/allbooks.html', '_blank');
        }

        function testSystemStatus() {
            showResults('æµ‹è¯•ç³»ç»ŸçŠ¶æ€...');
            fetch('http://localhost:9000/')
                .then(response => {
                    showResults(`ç³»ç»ŸçŠ¶æ€: ${response.status} ${response.statusText}`);
                    return response.text();
                })
                .then(data => {
                    showResults('ç³»ç»Ÿå“åº”æ­£å¸¸ï¼Œé¦–é¡µå¯è®¿é—®');
                })
                .catch(error => {
                    showResults('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message);
                });
        }

        function testDatabase() {
            showResults('æµ‹è¯•æ•°æ®åº“è¿æ¥...');
            fetch('http://localhost:9000/allbooks.html')
                .then(response => {
                    if (response.ok) {
                        showResults('æ•°æ®åº“è¿æ¥æ­£å¸¸ - å›¾ä¹¦åˆ—è¡¨é¡µé¢å¯è®¿é—®');
                    } else {
                        showResults(`æ•°æ®åº“è¿æ¥å¯èƒ½æœ‰é—®é¢˜ - çŠ¶æ€ç : ${response.status}`);
                    }
                })
                .catch(error => {
                    showResults('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                });
        }

        function checkLogs() {
            showResults('æŸ¥çœ‹æ—¥å¿—åŠŸèƒ½éœ€è¦åœ¨æœåŠ¡å™¨ç«¯å®ç°');
        }

        function testSimpleAdd() {
            showResults('å¼€å§‹ç®€å•å›¾ä¹¦æ·»åŠ æµ‹è¯•...');
            const testData = new FormData();
            testData.append('name', 'æµ‹è¯•å›¾ä¹¦_' + Date.now());
            testData.append('author', 'æµ‹è¯•ä½œè€…');
            testData.append('publish', 'æµ‹è¯•å‡ºç‰ˆç¤¾');
            testData.append('isbn', '978-7-111-' + Math.floor(Math.random() * 100000));
            testData.append('introduction', 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•å›¾ä¹¦');
            testData.append('language', 'ä¸­æ–‡');
            testData.append('price', '25.99');
            testData.append('pubdate', '2024-01-01');
            testData.append('classId', '1');
            testData.append('pressmark', '1001');
            testData.append('state', '1');

            submitFormData(testData, 'ç®€å•æ·»åŠ æµ‹è¯•');
        }

        function testComplexAdd() {
            showResults('å¼€å§‹å¤æ‚æ•°æ®æµ‹è¯•...');
            const testData = new FormData();
            testData.append('name', 'å¤æ‚æµ‹è¯•å›¾ä¹¦ã€Šç‰¹æ®Šå­—ç¬¦#@$%ã€‹');
            testData.append('author', 'Test Author with Numbers 123');
            testData.append('publish', 'ç‰¹æ®Šå‡ºç‰ˆç¤¾ï¼ˆæµ‹è¯•ï¼‰');
            testData.append('isbn', '978-7-111-99999-9');
            testData.append('introduction', 'è¿™æ˜¯ä¸€ä¸ªåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„ç®€ä»‹ï¼š!@#$%^&*()_+{}|:"<>?[]\\;\',./');
            testData.append('language', 'ä¸­è‹±æ–‡æ··åˆ Mixed Language');
            testData.append('price', '999.99');
            testData.append('pubdate', '2023-12-31');
            testData.append('classId', '999');
            testData.append('pressmark', '9999');
            testData.append('state', '0');

            submitFormData(testData, 'å¤æ‚æ•°æ®æµ‹è¯•');
        }

        function testInvalidData() {
            showResults('å¼€å§‹æ— æ•ˆæ•°æ®æµ‹è¯•...');
            const testData = new FormData();
            testData.append('name', ''); // ç©ºåç§°
            testData.append('author', '');
            testData.append('publish', '');
            testData.append('isbn', 'invalid-isbn');
            testData.append('introduction', '');
            testData.append('language', '');
            testData.append('price', '-10'); // è´Ÿä»·æ ¼
            testData.append('pubdate', 'invalid-date');
            testData.append('classId', '0'); // æ— æ•ˆåˆ†ç±»å·
            testData.append('pressmark', '-1'); // è´Ÿä¹¦æ¶å·
            testData.append('state', '999'); // æ— æ•ˆçŠ¶æ€

            submitFormData(testData, 'æ— æ•ˆæ•°æ®æµ‹è¯•');
        }

        function submitFormData(formData, testName) {
            fetch('http://localhost:9000/book_add_do.html', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                showResults(`${testName} - å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                if (response.status === 400) {
                    showResults(`${testName} - æ£€æµ‹åˆ°HTTP 400é”™è¯¯ï¼`);
                }
                return response.text();
            })
            .then(data => {
                if (data.includes('æˆåŠŸ')) {
                    showResults(`${testName} - æˆåŠŸï¼`);
                } else if (data.includes('å¤±è´¥') || data.includes('é”™è¯¯')) {
                    showResults(`${testName} - å¤±è´¥æˆ–æœ‰é”™è¯¯ä¿¡æ¯`);
                } else {
                    showResults(`${testName} - å“åº”å†…å®¹é•¿åº¦: ${data.length} å­—ç¬¦`);
                }
            })
            .catch(error => {
                showResults(`${testName} - è¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }

        function diagnose400Error() {
            showResults('å¼€å§‹HTTP 400é”™è¯¯è¯Šæ–­...');
            
            // æµ‹è¯•1: ç©ºè¡¨å•æäº¤
            showResults('æµ‹è¯•1: ç©ºè¡¨å•æäº¤');
            fetch('http://localhost:9000/book_add_do.html', {
                method: 'POST',
                body: new FormData()
            }).then(response => {
                showResults(`ç©ºè¡¨å•æµ‹è¯• - çŠ¶æ€: ${response.status}`);
            }).catch(e => showResults(`ç©ºè¡¨å•æµ‹è¯•å¤±è´¥: ${e.message}`));

            // æµ‹è¯•2: åªåŒ…å«å¿…éœ€å­—æ®µ
            setTimeout(() => {
                showResults('æµ‹è¯•2: åªåŒ…å«å¿…éœ€å­—æ®µ');
                const minData = new FormData();
                minData.append('name', 'æœ€å°æµ‹è¯•');
                minData.append('author', 'ä½œè€…');
                minData.append('price', '10.00');
                
                fetch('http://localhost:9000/book_add_do.html', {
                    method: 'POST',
                    body: minData
                }).then(response => {
                    showResults(`æœ€å°å­—æ®µæµ‹è¯• - çŠ¶æ€: ${response.status}`);
                }).catch(e => showResults(`æœ€å°å­—æ®µæµ‹è¯•å¤±è´¥: ${e.message}`));
            }, 1000);

            // æµ‹è¯•3: æ£€æŸ¥Content-Type
            setTimeout(() => {
                showResults('æµ‹è¯•3: æ£€æŸ¥Content-Typeè®¾ç½®');
                const formData = new FormData();
                formData.append('name', 'Content-Typeæµ‹è¯•');
                
                fetch('http://localhost:9000/book_add_do.html', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: 'name=URLç¼–ç æµ‹è¯•&author=æµ‹è¯•ä½œè€…&price=15.00'
                }).then(response => {
                    showResults(`Content-Typeæµ‹è¯• - çŠ¶æ€: ${response.status}`);
                }).catch(e => showResults(`Content-Typeæµ‹è¯•å¤±è´¥: ${e.message}`));
            }, 2000);
        }

        function testFormSubmission() {
            showResults('æµ‹è¯•è¡¨å•æäº¤æœºåˆ¶...');
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            
            // æ˜¾ç¤ºå°†è¦æäº¤çš„æ•°æ®
            let dataStr = 'å‡†å¤‡æäº¤çš„æ•°æ®:\n';
            for (let [key, value] of formData.entries()) {
                dataStr += `${key}: ${value}\n`;
            }
            showResults(dataStr);
            
            submitFormData(formData, 'è¡¨å•æäº¤æµ‹è¯•');
        }

        function validateInputs() {
            showResults('éªŒè¯è¾“å…¥æ ¼å¼...');
            const form = document.getElementById('testForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            let validationResults = 'è¾“å…¥éªŒè¯ç»“æœ:\n';
            inputs.forEach(input => {
                const value = input.value;
                const type = input.type;
                const name = input.name;
                
                let valid = true;
                let reason = '';
                
                if (type === 'number') {
                    if (isNaN(parseFloat(value))) {
                        valid = false;
                        reason = 'ä¸æ˜¯æœ‰æ•ˆæ•°å­—';
                    }
                } else if (type === 'date') {
                    if (!value || isNaN(Date.parse(value))) {
                        valid = false;
                        reason = 'ä¸æ˜¯æœ‰æ•ˆæ—¥æœŸ';
                    }
                } else if (name === 'price') {
                    if (parseFloat(value) <= 0) {
                        valid = false;
                        reason = 'ä»·æ ¼å¿…é¡»å¤§äº0';
                    }
                }
                
                validationResults += `${name}: ${valid ? 'âœ“' : 'âœ—'} ${reason}\n`;
            });
            
            showResults(validationResults);
        }

        function submitTestForm() {
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            submitFormData(formData, 'æ‰‹åŠ¨è¡¨å•æäº¤');
        }

        function fillRandomData() {
            const timestamp = Date.now();
            document.getElementById('name').value = `éšæœºå›¾ä¹¦_${timestamp}`;
            document.getElementById('author').value = `éšæœºä½œè€…_${Math.floor(Math.random() * 1000)}`;
            document.getElementById('publish').value = `éšæœºå‡ºç‰ˆç¤¾_${Math.floor(Math.random() * 100)}`;
            document.getElementById('isbn').value = `978-7-${Math.floor(Math.random() * 1000)}-${Math.floor(Math.random() * 100000)}-${Math.floor(Math.random() * 10)}`;
            document.getElementById('price').value = (Math.random() * 100 + 10).toFixed(2);
            document.getElementById('classId').value = Math.floor(Math.random() * 10) + 1;
            document.getElementById('pressmark').value = Math.floor(Math.random() * 9000) + 1000;
            
            showResults('å·²å¡«å……éšæœºæ•°æ®');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.onload = function() {
            showResults('å›¾ä¹¦æ·»åŠ åŠŸèƒ½æµ‹è¯•å·¥å…·å·²åŠ è½½');
            setTimeout(testSystemStatus, 1000);
        };
    </script>
</body>
</html>
