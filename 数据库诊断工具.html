<!DOCTYPE html>
<html>
<head>
    <title>æ•°æ®åº“è¯Šæ–­å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .test-btn { 
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px;
            font-weight: bold;
        }
        .test-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #result { 
            margin-top: 20px; 
            padding: 15px; 
            background: rgba(0,0,0,0.2);
            border-radius: 8px; 
            white-space: pre-wrap; 
            font-family: monospace;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .error { color: #ff6b6b; }
        .success { color: #4CAF50; }
        .info { color: #64b5f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å›¾ä¹¦æœç´¢åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š æ•°æ®åº“æ£€æŸ¥</h3>
            <button class="test-btn" onclick="checkAllBooks()">æ£€æŸ¥æ‰€æœ‰å›¾ä¹¦</button>
            <button class="test-btn" onclick="checkBookCount()">æ£€æŸ¥å›¾ä¹¦æ•°é‡</button>
            <button class="test-btn" onclick="testBookSearch()">æµ‹è¯•å›¾ä¹¦æœç´¢</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æœç´¢æµ‹è¯•</h3>
            <input type="text" id="searchInput" placeholder="è¾“å…¥æœç´¢å…³é”®è¯" style="padding: 10px; margin: 5px; border-radius: 5px; border: none; width: 200px;">
            <button class="test-btn" onclick="searchBooks()">æœç´¢å›¾ä¹¦</button>
            <button class="test-btn" onclick="matchBooks()">åŒ¹é…è®¡æ•°</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ SQLè¯­å¥æµ‹è¯•</h3>
            <button class="test-btn" onclick="testSQL()">æµ‹è¯•SQLè¯­å¥</button>
            <button class="test-btn" onclick="checkDBConnection()">æ£€æŸ¥æ•°æ®åº“è¿æ¥</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        function showResult(message, type = 'info') {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            result.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>\n`;
            result.scrollTop = result.scrollHeight;
        }

        function clearResult() {
            document.getElementById('result').innerHTML = '';
        }

        async function makeRequest(url, data = null) {
            try {
                const options = {
                    method: data ? 'POST' : 'GET',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                };
                
                if (data) {
                    options.body = new URLSearchParams(data);
                }
                
                const response = await fetch(url, options);
                return await response.text();
            } catch (error) {
                throw new Error(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function checkAllBooks() {
            showResult('ğŸ” æ£€æŸ¥æ‰€æœ‰å›¾ä¹¦æ•°æ®...', 'info');
            try {
                const result = await makeRequest('http://localhost:9000/allbooks.html');
                if (result.includes('å›¾ä¹¦ä¿¡æ¯')) {
                    showResult('âœ… æˆåŠŸè·å–å›¾ä¹¦åˆ—è¡¨é¡µé¢', 'success');
                    // åˆ†æé¡µé¢å†…å®¹
                    const bookCount = (result.match(/class="btn btn-success btn-xs">è¯¦æƒ…/g) || []).length;
                    showResult(`ğŸ“Š é¡µé¢ä¸­æ˜¾ç¤º ${bookCount} æœ¬å›¾ä¹¦`, 'info');
                } else {
                    showResult('âŒ è·å–å›¾ä¹¦åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testBookSearch() {
            showResult('ğŸ§ª æµ‹è¯•å›¾ä¹¦æœç´¢åŠŸèƒ½...', 'info');
            try {
                // æµ‹è¯•æœç´¢"java"
                const result = await makeRequest('http://localhost:9000/reader_querybook_do.html', {
                    searchWord: 'java'
                });
                
                if (result.includes('æ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦')) {
                    showResult('âŒ æœç´¢"java"æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å›¾ä¹¦', 'error');
                } else if (result.includes('æŸ¥è¯¢ç»“æœ')) {
                    showResult('âœ… æœç´¢"java"æ‰¾åˆ°äº†åŒ¹é…çš„å›¾ä¹¦', 'success');
                } else {
                    showResult('âš ï¸ æœç´¢ç»“æœæœªçŸ¥', 'info');
                }
            } catch (error) {
                showResult(`âŒ æœç´¢æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function searchBooks() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                showResult('âŒ è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }

            showResult(`ğŸ” æœç´¢å…³é”®è¯: "${keyword}"`, 'info');
            try {
                const result = await makeRequest('http://localhost:9000/reader_querybook_do.html', {
                    searchWord: keyword
                });
                
                if (result.includes('æ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦')) {
                    showResult(`âŒ æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${keyword}"çš„å›¾ä¹¦`, 'error');
                } else if (result.includes('æŸ¥è¯¢ç»“æœ')) {
                    showResult(`âœ… æ‰¾åˆ°äº†åŒ…å«"${keyword}"çš„å›¾ä¹¦`, 'success');
                    // ç»Ÿè®¡ç»“æœæ•°é‡
                    const bookCount = (result.match(/readerbookdetail\.html/g) || []).length;
                    showResult(`ğŸ“Š æ‰¾åˆ° ${bookCount} æœ¬ç›¸å…³å›¾ä¹¦`, 'info');
                } else {
                    showResult('âš ï¸ æœç´¢ç»“æœæ ¼å¼å¼‚å¸¸', 'info');
                }
            } catch (error) {
                showResult(`âŒ æœç´¢é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function matchBooks() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                showResult('âŒ è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }

            showResult(`ğŸ”¢ æ£€æŸ¥"${keyword}"çš„åŒ¹é…æ•°é‡...`, 'info');
            // è¿™é‡Œæˆ‘ä»¬é€šè¿‡æœç´¢é¡µé¢æ¥é—´æ¥æµ‹è¯•åŒ¹é…åŠŸèƒ½
            await searchBooks();
        }

        async function testSQL() {
            showResult('ğŸ—„ï¸ æµ‹è¯•SQLæŸ¥è¯¢è¯­å¥...', 'info');
            showResult('SQL: SELECT * FROM book_info WHERE CAST(book_id AS CHAR) like ? or name like ? or author like ? or publish like ?', 'info');
            showResult('å‚æ•°æ ¼å¼: %keyword%, %keyword%, %keyword%, %keyword%', 'info');
            
            // æµ‹è¯•å‡ ä¸ªå¸¸è§çš„æœç´¢è¯
            const testWords = ['java', 'spring', 'æ•°æ®åº“', '1'];
            for (const word of testWords) {
                showResult(`æµ‹è¯•å…³é”®è¯: "${word}"`, 'info');
                try {
                    const result = await makeRequest('http://localhost:9000/reader_querybook_do.html', {
                        searchWord: word
                    });
                    
                    if (result.includes('æ²¡æœ‰åŒ¹é…çš„å›¾ä¹¦')) {
                        showResult(`  âŒ "${word}" - æ— åŒ¹é…ç»“æœ`, 'error');
                    } else if (result.includes('æŸ¥è¯¢ç»“æœ')) {
                        showResult(`  âœ… "${word}" - æœ‰åŒ¹é…ç»“æœ`, 'success');
                    } else {
                        showResult(`  âš ï¸ "${word}" - ç»“æœæœªçŸ¥`, 'info');
                    }
                } catch (error) {
                    showResult(`  âŒ "${word}" - æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
                
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        async function checkDBConnection() {
            showResult('ğŸ”— æ£€æŸ¥æ•°æ®åº“è¿æ¥...', 'info');
            try {
                // é€šè¿‡è®¿é—®ä¸»é¡µæ¥æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
                const result = await makeRequest('http://localhost:9000/login.html');
                if (result.includes('ç™»å½•') || result.includes('ç”¨æˆ·ç±»å‹')) {
                    showResult('âœ… åº”ç”¨æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ', 'success');
                    showResult('âœ… æ•°æ®åº“è¿æ¥åº”è¯¥æ­£å¸¸ï¼ˆèƒ½è®¿é—®ç™»å½•é¡µé¢ï¼‰', 'success');
                } else {
                    showResult('âŒ åº”ç”¨æœåŠ¡å™¨å¯èƒ½æœ‰é—®é¢˜', 'error');
                }
            } catch (error) {
                showResult(`âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}`, 'error');
                showResult('è¯·ç¡®ä¿æœåŠ¡å™¨åœ¨ http://localhost:9000 è¿è¡Œ', 'info');
            }
        }

        async function checkBookCount() {
            showResult('ğŸ“Š æ£€æŸ¥æ•°æ®åº“ä¸­çš„å›¾ä¹¦æ•°é‡...', 'info');
            try {
                // é€šè¿‡ç®¡ç†å‘˜é¡µé¢æ£€æŸ¥å›¾ä¹¦æ€»æ•°
                const result = await makeRequest('http://localhost:9000/allbooks.html');
                
                // å°è¯•è®¡ç®—é¡µé¢ä¸­çš„å›¾ä¹¦æ•°é‡
                const bookRows = result.match(/<tr>\s*<td>.*?<\/td>\s*<td>.*?<\/td>/g);
                if (bookRows) {
                    const count = bookRows.length - 1; // å‡å»è¡¨å¤´
                    showResult(`ğŸ“š æ•°æ®åº“ä¸­å¤§çº¦æœ‰ ${count} æœ¬å›¾ä¹¦`, count > 0 ? 'success' : 'error');
                } else {
                    showResult('âŒ æ— æ³•ç¡®å®šå›¾ä¹¦æ•°é‡ï¼Œå¯èƒ½æ•°æ®åº“ä¸ºç©º', 'error');
                }
            } catch (error) {
                showResult(`âŒ æ£€æŸ¥å›¾ä¹¦æ•°é‡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åŸºæœ¬è¿æ¥
        window.onload = function() {
            showResult('ğŸš€ å›¾ä¹¦æœç´¢è¯Šæ–­å·¥å…·å·²å¯åŠ¨', 'success');
            showResult('è¯·ç¡®ä¿å›¾ä¹¦ç®¡ç†ç³»ç»Ÿåœ¨ http://localhost:9000 è¿è¡Œ', 'info');
            setTimeout(checkDBConnection, 1000);
        };
    </script>
</body>
</html>
